function makeLabel(a,b){return`${a}_${b}`}function makeStartMarkLabel(a){return makeLabel(a,"start")}function makeEndMarkLabel(a){return makeLabel(a,"end")}function makeMeasurementLabel(a){return a}function startMeasurement(a){const b=makeStartMarkLabel(a);performance.mark(b)}function endMeasurement(a){const b=makeStartMarkLabel(a),c=makeEndMarkLabel(a),d=makeMeasurementLabel(a);performance.mark(c),performance.measure(d,{start:b,end:c})}function outputRecalculatingHandler(a){const b=a.target.id;startMeasurement(b)}function outputValueHandler(a){const b=a.target.id;setTimeout(()=>{endMeasurement(b)},0)}function serverBusyHandler(){startMeasurement("server_computation")}function serverIdleHandler(){endMeasurement("server_computation")}function customMessageEventHandler(a){if(void 0===a.message.custom)return;const b=Object.keys(a.message.custom)[0];startMeasurement(b),setTimeout(()=>{endMeasurement(b)},0)}$(document).ready(function(){$(document).on("shiny:recalculating",outputRecalculatingHandler),$(document).on("shiny:value",outputValueHandler),$(document).on("shiny:busy",serverBusyHandler),$(document).on("shiny:idle",serverIdleHandler),$(document).on("shiny:message",customMessageEventHandler)});function showAllMeasurements(){const a=performance.getEntriesByType("measure");a.forEach(a=>{console.log(`${a.name}'s duration: ${a.duration}`)})}function showSummarisedMeasurements(){var a=Math.max;const b=makeMeasurementLabel("server_computation"),c=performance.getEntriesByType("measure"),d=a(...c.filter(a=>a.name===b).map(a=>a.duration)),e=a(...c.filter(a=>a.name!==b).map(a=>a.duration)),f=c.filter(a=>a.duration===e).map(a=>a.name)[0];console.log(`Slowest Server Computation: ${d}`),console.log(`Slowest output computation: ${e} (${f})`)}function getCurrentDateTime(){const a=new Date,b=a.getFullYear(),c=(a.getMonth()+1+"").padStart(2,"0"),d=(a.getDate()+"").padStart(2,"0"),e=(a.getHours()+"").padStart(2,"0"),f=(a.getMinutes()+"").padStart(2,"0"),g=(a.getSeconds()+"").padStart(2,"0");return`${b}_${c}_${d}-${e}_${f}_${g}`}function downloadFile(a,b,c){const d=new Blob([a],{type:b}),e=document.createElement("a"),f=window.URL.createObjectURL(d);e.href=f,e.download=c,e.click(),window.URL.revokeObjectURL(f)}function downloadCsvFile(a){const b=a.map(a=>a.join(",")).join("\n");downloadFile(b,"text/csv;charset=utf-8",`${getCurrentDateTime()}-tictoc.csv`)}function getMeasurements(){return performance.getEntries().filter(a=>null!=a&&"object"==typeof a&&"measure"===a.entryType&&a.name&&"number"==typeof a.duration&&"number"==typeof a.startTime).map(a=>({name:a?.name||"",duration:a?.duration||0,startTime:a?.startTime||0}))}function prepareCsvData(){const a=getMeasurements().map(a=>[a.name,a.startTime,a.duration]),b=[["measurement_id","start_time","duration (ms)"]].concat(a);return b}function exportMeasurements(){csvData=prepareCsvData(),downloadCsvFile(csvData)}function plotMeasurements(){const a=document.getElementById("measurementsTimeline"),b=echarts.init(a),c=JSON.parse(document.getElementById("measurementData").text),d=c.map(a=>a.name),e=[...new Set(d)],f=c.map(a=>{const b=e.indexOf(a.name);return{name:a.name,value:[b,a.startTime,a.startTime+a.duration,a.duration]}});b.setOption({tooltip:{formatter:function(a){return a.marker+a.name+": "+a.value[3]+" ms"}},title:{text:"shiny.tictoc report",left:"center"},dataZoom:[{type:"slider",filterMode:"weakFilter",showDataShadow:!1,top:400,labelFormatter:""},{type:"inside",filterMode:"weakFilter"}],grid:{height:300,containLabel:!0},xAxis:{min:0,scale:!0,axisLabel:{formatter:function(a){return Math.max(0,a)+" ms"}}},yAxis:{data:e},series:[{type:"custom",renderItem:function(a,b){const c=b.value(0),d=b.coord([b.value(1),c]),e=b.coord([b.value(2),c]),f=.6*b.size([0,1])[1],g=echarts.graphic.clipRectByRect({x:d[0],y:d[1]-f/2,width:e[0]-d[0],height:f},{x:a.coordSys.x,y:a.coordSys.y,width:a.coordSys.width,height:a.coordSys.height});return g&&{type:"rect",transition:["shape"],shape:g,style:b.style()}},itemStyle:{opacity:.8},encode:{x:[1,2],y:0},data:f}]})}async function createHtmlReport(){const a=getMeasurements(),b=document.implementation.createHTMLDocument("shiny.tictoc report"),c=document.createElement("script");c.id="measurementData",c.type="application/json",c.innerText=`${JSON.stringify(a)}`;const d=document.createElement("div");d.id="measurementsTimeline",d.style.height="100vh";const e=await fetch("https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js").then(a=>a.text()),f=document.createElement("script");f.text=e;const g=document.createElement("script");return g.text=`${plotMeasurements.toString()}; window.onload = plotMeasurements`,b.head.appendChild(f),b.head.appendChild(c),b.head.appendChild(g),b.body.appendChild(d),b}async function exportHtmlReport(){const a=await createHtmlReport();downloadFile(a.documentElement.innerHTML,"text/html;charset=utf-8",`${getCurrentDateTime()}-tictoc.html`)}